# generated: 2025-11-11 21:21:58Z
# project: mp3_to_8D

**Date:** 2025-11-11  # project_key: mp3_to_8D

**Epic:** E3 – Preset & Mode Orchestration  # tracking_system: file-system

**Status:** All 3 stories drafted ✅# story_location: docs/stories



---# STATUS DEFINITIONS:

# ==================

## Stories Created# Epic Status:

#   - backlog: Epic exists in epic file but not contexted

### Story 3-1: Quick Mode Presets#   - contexted: Epic tech context created (required before drafting stories)

**File:** `docs/stories/3-1-quick-mode-presets.md` (850+ lines)#

# Story Status:

**Summary:** One-tap activation of Focus/Calm/Energize presets with <100ms latency.#   - backlog: Story only exists in epic file

#   - drafted: Story file created in stories folder

**Key Features:**#   - ready-for-dev: Draft approved and story context created

- `applyPreset()` helper updates all 8 audio parameters#   - in-progress: Developer actively working on implementation

- `activePresetId` state tracks current selection#   - review: Under SM review (via code-review workflow)

- Mode chips wired with proper aria-selected/aria-current#   - done: Story completed

- Editable default presets via settings panel#

- Performance target: <100ms perceived latency# Retrospective Status:

#   - optional: Can be completed but not required

**Testing Plan:**#   - completed: Retrospective has been done

- 5 unit tests#

- 3 integration tests# WORKFLOW NOTES:

- 7 manual tests (including accessibility, performance)# ===============

# - Epics should be 'contexted' before stories can be 'drafted'

**Estimated Effort:** ~3 hours (6 tasks)# - Stories can be worked in parallel if team capacity allows

# - SM typically drafts next story after previous one is 'done' to incorporate learnings

---# - Dev moves story to 'review', SM reviews, then Dev moves to 'done'



### Story 3-2: Advanced Controls Drawer & Live Bindinggenerated: 2025-11-11 21:21:58Z

**File:** `docs/stories/3-2-advanced-controls-drawer.md` (900+ lines)project: mp3_to_8D

project_key: mp3_to_8D

**Summary:** Expandable drawer with sliders for all 8 audio parameters, instant reflection in audio graph.tracking_system: file-system

story_location: docs/stories

**Key Features:**

- AdvancedControls component with 8 sliders/dropdownsdevelopment_status:

- Live parameter binding (leverages existing Epic 1 useEffects)  epic-1: backlog

- Keyboard shortcut: Ctrl+E to toggle drawer  1-1-consolidated-shell-and-navigation: done

- Sensor lock UI for Epic 5 adaptive mode integration  1-2-breathing-ritual-auto-start: done

- Helper text for each parameter (binaural bands, movement patterns)  1-3-personalization-accessibility-toggles: done

  epic-1-retrospective: completed

**Testing Plan:**  epic-2: done

- 3 unit tests  2-1-drag-drop-file-picker-refactor: done

- 4 integration tests  2-2-streaming-url-validation-messaging: done

- 8 manual tests (including accessibility, performance, responsive)  2-3-audio-graph-regression-harness: done

  epic-2-retrospective: completed

**Estimated Effort:** ~4 hours (6 tasks)  epic-3:

    status: contexted

---    title: "Preset & Mode Orchestration"

  3-1-quick-mode-presets: drafted

### Story 3-3: Custom Preset CRUD & Auto-Restore  3-2-advanced-controls-drawer-live-binding: drafted

**File:** `docs/stories/3-3-custom-preset-crud.md` (1,100+ lines)  3-3-custom-preset-crud-auto-restore: drafted

  epic-3-retrospective: optional

**Summary:** Save, edit, delete, reorder custom presets. Auto-restore last preset per track on replay.  epic-4: backlog

  4-1-session-schema-lifecycle-hooks: backlog

**Key Features:**  4-2-emoji-check-in-notes-prompt: backlog

- Complete CRUD operations with localStorage persistence  4-3-insights-dashboard-export: backlog

- SavePresetDialog with validation (name 50 chars, description 200 chars)  epic-4-retrospective: optional

- PresetList component with drag/drop reordering  epic-5: backlog

- Track schema extension: `lastPresetId`, `preferredPresetId`  5-1-capability-detection-consent-ui: backlog

- Auto-restore logic in `playTrack()` function  5-2-heart-rate-subscription-threshold-engine: backlog

- Export/import preset JSON (stretch goal)  5-3-sensor-informed-preset-adjustments: backlog

  epic-5-retrospective: optional

**Testing Plan:**  epic-6: backlog

- 8 unit tests  6-1-service-worker-offline-ux: backlog

- 6 integration tests  6-2-manifest-install-flow: backlog

- 12 manual tests (including edge cases, persistence, accessibility)  6-3-accessibility-observability-suite: backlog

  epic-6-retrospective: optional

**Estimated Effort:** ~6 hours (6 tasks)

---

## Epic 3 Total Scope

**Lines of Story Documentation:** ~2,850 lines across 3 stories  
**Total Estimated Effort:** ~13 hours (18 tasks)  
**Test Coverage:** 27 automated tests + 27 manual tests  

**Dependencies Met:**
- ✅ Epic 1 complete (hero UI, mode chips, audio parameter hooks)
- ✅ Epic 2 complete (toast system, playlist schema, localStorage patterns)

**Blocks Future Work:**
- Epic 4: Session tracking (needs `lastPresetId` for analytics)
- Epic 5: Adaptive sensors (needs sensor lock UI, preset application)

---

## Success Metrics (All Stories)

| Metric | Target | Measurement |
|--------|--------|-------------|
| Preset Reuse Rate | ≥80% | % sessions using saved/default preset |
| Parameter Latency | <100ms | performance.measure() on onChange |
| Preset Adoption | ≥60% | % users who save ≥1 custom preset |
| Auto-Restore Success | ≥90% | % track replays that restore correctly |

---

## Implementation Strategy

### Phase 1: Story 3-1 (Quick Mode Presets)
**Why First:** Establishes foundation for preset system. Other stories depend on `applyPreset()` helper and `activePresetId` state.

**Critical Path:**
1. Extract `applyPreset()` helper
2. Add `activePresetId` state
3. Wire mode chips to preset application
4. Add logging for Epic 4 integration

**Risk:** Preset switching causes audio dropouts  
**Mitigation:** Leverage existing useEffects (already proven smooth in Epic 1/2)

---

### Phase 2: Story 3-2 (Advanced Controls)
**Why Second:** Users need sliders to create custom parameter combinations before saving presets.

**Critical Path:**
1. Build AdvancedControls component structure
2. Wire live parameter binding (use existing state/setters)
3. Add keyboard shortcut (Ctrl+E)
4. Style with responsive CSS grid

**Risk:** Slider updates lag or cause re-render storms  
**Mitigation:** React 18 automatic batching prevents excessive renders. Existing useEffects already optimized.

---

### Phase 3: Story 3-3 (Custom Preset CRUD)
**Why Last:** Depends on Stories 3-1 (applyPreset) and 3-2 (parameter tweaking UI).

**Critical Path:**
1. Define localStorage schema and CRUD helpers
2. Build SavePresetDialog with validation
3. Build PresetList with drag/drop
4. Implement track auto-restore logic
5. Add delete confirmation

**Risk:** localStorage quota exceeded  
**Mitigation:** Limit to 50 presets, show storage warning, implement export as backup

---

## Quality Gates (All Stories)

### Code Quality
- [ ] All code follows Epic 2 patterns (try/finally, refs for cleanup, functional setState)
- [ ] No console errors or warnings
- [ ] ESLint/TypeScript checks pass (if enabled)
- [ ] Code comments explain complex logic

### Performance
- [ ] Preset application <100ms latency
- [ ] No audio dropouts during parameter changes
- [ ] No memory leaks (test 100+ operations)
- [ ] Responsive on mobile (tested 320px viewport)

### Accessibility (WCAG AA)
- [ ] All controls keyboard accessible
- [ ] aria-selected/aria-current properly set
- [ ] Screen reader announces state changes
- [ ] Focus indicators visible
- [ ] Tap targets ≥48px on mobile

### Testing
- [ ] All unit tests passing
- [ ] All integration tests passing
- [ ] Manual smoke tests documented
- [ ] Epic 1/2 regression tests still passing
- [ ] Edge cases tested (quota, deleted presets, etc.)

### Documentation
- [ ] Code comments explain architecture decisions
- [ ] Test results documented in test artifacts
- [ ] localStorage schema documented
- [ ] Migration path to IndexedDB planned (Epic 4)

---

## Story Sequencing & Parallelization

### Sequential Work (Cannot Parallelize)
1. Story 3-1 MUST complete before 3-2 (needs `applyPreset()`, `activePresetId`)
2. Story 3-2 MUST complete before 3-3 (users need sliders to create parameters)

### Potential Parallelization (If Team Capacity)
- Story 3-1 implementation + Story 3-2 UI design/CSS (different developers)
- Story 3-3 localStorage schema design while 3-2 in development

**Recommendation:** Serial execution for single developer (minimize context switching)

---

## Sprint Status Updates

**Before:**
```yaml
epic-3:
  status: contexted
  title: "Preset & Mode Orchestration"
3-1-quick-mode-presets: backlog
3-2-advanced-controls-drawer-live-binding: backlog
3-3-custom-preset-crud-auto-restore: backlog
```

**After:**
```yaml
  epic-3:
    status: in-progress
    title: "Preset & Mode Orchestration"
  3-1-quick-mode-presets: done
  3-2-advanced-controls-drawer-live-binding: ready-for-dev
  3-3-custom-preset-crud-auto-restore: drafted
```

---

## Next BMad Workflow Steps

### Option 1: Begin Story Implementation
```bash
workflow story-context 3-1-quick-mode-presets
workflow develop-story
```

### Option 2: Sprint Planning Review
```bash
workflow sprint-planning
# Review all drafted stories, adjust estimates, commit to sprint
```

### Option 3: Create Additional Context
```bash
workflow epic-tech-context epic-4
# Get ahead on Epic 4 planning while Epic 3 is fresh
```

---

## Files Created

1. **`docs/epic-3-preset-mode-orchestration.context.xml`** (1,344 lines)
   - Comprehensive technical context for Epic 3
   - Problem statement, solution approach, implementation roadmap
   - Testing pyramid, success metrics, risk analysis

2. **`docs/stories/3-1-quick-mode-presets.md`** (~850 lines)
   - Story specification with 5 ACs
   - 6 implementation tasks with code samples
   - 15 test cases (5 unit + 3 integration + 7 manual)

3. **`docs/stories/3-2-advanced-controls-drawer.md`** (~900 lines)
   - Story specification with 5 ACs
   - 6 implementation tasks with full component code
   - 15 test cases (3 unit + 4 integration + 8 manual)

4. **`docs/stories/3-3-custom-preset-crud.md`** (~1,100 lines)
   - Story specification with 6 ACs
   - 6 implementation tasks with CRUD helpers
   - 26 test cases (8 unit + 6 integration + 12 manual)

5. **`.bmad-ephemeral/sprint-status.yaml`** (updated)
   - Epic 3 status: contexted
   - All 3 stories: drafted

**Total Documentation:** ~4,200 lines across 5 files

---

## Key Takeaways

### Architecture Wins
- **Leverages existing code:** Stories 3-1 and 3-2 reuse Epic 1/2 hooks, no new audio code needed
- **localStorage proven pattern:** Epic 2 established localStorage patterns (skip ritual, dark mode)
- **Future-ready:** Telemetry events structured for Epic 4, sensor lock UI ready for Epic 5

### Risk Mitigation Built-In
- Performance targets defined with measurement code
- Edge cases identified (quota limits, deleted presets, name collisions)
- Accessibility baked in from start (not retrofitted)
- Regression testing strategy preserves Epic 1/2 stability

### Developer Experience
- Each story has complete code samples (copy-paste ready)
- Testing plans guide TDD approach
- Dependencies clearly mapped (no surprises)
- Estimated effort helps capacity planning

### User Experience
- Progressive disclosure: Quick modes → Advanced controls → Custom presets
- Auto-restore reduces cognitive load (remembers what worked)
- Consistent visual language (accent colors, badges, aria states)
- Graceful fallbacks (deleted presets don't crash app)

---

## Epic 3 Ready for Implementation ✅

All planning artifacts complete:
- ✅ Epic technical context created
- ✅ 3 stories drafted with full specifications
- ✅ Success metrics defined
- ✅ Testing strategy planned
- ✅ Dependencies validated
- ✅ Sprint status updated

**Recommended Next Action:** `workflow story-context 3-1-quick-mode-presets`
