<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>E3</epicId>
    <storyId>3-3</storyId>
    <title>Custom Preset CRUD & Auto-Restore</title>
    <status>drafted</status>
    <generatedAt>2025-11-24</generatedAt>
    <generator>BMAD Story Context Workflow v6</generator>
    <sourceStoryPath>docs/stories/3-3-custom-preset-crud.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>parent creating a bedtime routine for my neurodivergent child</asA>
    <iWant>to save our "Calm Bedtime" preset and have it auto-apply when we play our bedtime playlist</iWant>
    <soThat>we have consistent calming audio every night, reducing anxiety triggers</soThat>
    <tasks>
      - Task 3-3-1: Define Preset Storage Schema & Helpers (45 min)
      - Task 3-3-2: Build SavePresetDialog Component (60 min)
      - Task 3-3-3: Build PresetList Component (90 min)
      - Task 3-3-4: Implement Track Auto-Restore Logic (45 min)
      - Task 3-3-5: Add Delete Confirmation Modal (20 min)
      - Task 3-3-6: Implement Export/Import (Stretch Goal, 45 min)
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1">
      <title>Save Custom Preset from Advanced Controls</title>
      <summary>Modal dialog with name/description inputs creates preset in localStorage with 8 audio parameters, validates name length (max 50 chars), handles quota exceeded errors</summary>
    </criterion>
    <criterion id="AC2">
      <title>Preset List UI Shows All Presets</title>
      <summary>Display defaults (Focus/Calm/Energize) with "Default" badge + custom presets sorted by last used, keyboard navigation with Arrow keys, active preset highlighted</summary>
    </criterion>
    <criterion id="AC3">
      <title>Edit & Delete Custom Presets</title>
      <summary>Edit button opens dialog with pre-filled values, delete shows confirmation modal with warning if preset used by tracks, deleting active preset falls back to focus</summary>
    </criterion>
    <criterion id="AC4">
      <title>Playlist Track Auto-Restore</title>
      <summary>Track schema extended with lastPresetId field, replaying track restores preset before audio starts, handles deleted presets by falling back to focus</summary>
    </criterion>
    <criterion id="AC5">
      <title>Preset Reordering (Drag/Drop or Arrows)</title>
      <summary>Drag handle and arrow buttons allow reordering, order persists in preset-order localStorage array, keyboard shortcuts (Ctrl+Up/Down)</summary>
    </criterion>
    <criterion id="AC6">
      <title>Export/Import Preset JSON (Stretch Goal)</title>
      <summary>Export button downloads .preset.json file, import validates structure and handles name collisions with auto-rename</summary>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/PRD.md</path>
        <title>mp3_to_8D Product Requirements Document</title>
        <section>Scope - MVP</section>
        <snippet>Preset management – Focus/Calm/Energize quick modes + advanced sliders + ability to save custom stacks. Telemetry scaffolding – IndexedDB schema for session logs.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture – mp3_to_8D</title>
        <section>3.3 Preset & Mode Engine</section>
        <snippet>Preset definitions stored in IndexedDB store presets with schema {id, mode, params, tags, lastUsedAt, sensorOverrides}. usePresetEngine returns APIs to applyPreset(id), savePreset(payload), deletePreset(id).</snippet>
      </doc>
      <doc>
        <path>docs/epic-3-preset-mode-orchestration.context.xml</path>
        <title>Epic 3 Technical Context</title>
        <section>Story 3-3 - Custom Preset CRUD & Auto-Restore</section>
        <snippet>Users save, rename, reorder, delete custom presets. Each playlist track stores last-used preset ID for auto-restore on replay. Target: ≥80% preset reuse rate, ≥60% preset adoption, ≥90% auto-restore success.</snippet>
      </doc>
      <doc>
        <path>docs/stories/3-1-quick-mode-presets.md</path>
        <title>Story 3-1 – Quick Mode Presets</title>
        <section>Implementation Summary</section>
        <snippet>applyPreset() helper updates all 8 audio parameters in batch. activePresetId state tracks current selection. localStorage persistence with validation.</snippet>
      </doc>
      <doc>
        <path>docs/stories/3-2-advanced-controls-drawer.md</path>
        <title>Story 3-2 – Advanced Controls Drawer & Live Binding</title>
        <section>Key Features</section>
        <snippet>AdvancedControls component with 8 sliders/dropdowns. Live parameter binding leverages existing Epic 1 useEffects. Keyboard shortcut: Ctrl+E to toggle drawer.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>index.html</path>
        <kind>React component (main application file)</kind>
        <symbol>MODE_LIBRARY</symbol>
        <lines>666-717</lines>
        <reason>Contains default preset definitions (Focus, Calm, Energize) with structure that custom presets will follow. Defines preset schema with 8 audio parameters.</reason>
      </artifact>
      <artifact>
        <path>index.html</path>
        <kind>React state hook</kind>
        <symbol>activePresetId</symbol>
        <lines>1783</lines>
        <reason>Story 3-1 implementation: Tracks currently active preset by ID. Custom presets will use this state to apply and track active selections.</reason>
      </artifact>
      <artifact>
        <path>index.html</path>
        <kind>Helper function</kind>
        <symbol>applyPreset</symbol>
        <lines>2087-2114</lines>
        <reason>Story 3-1 implementation: Applies all 8 audio parameters from preset object. Custom presets will call this function to apply saved parameter combinations.</reason>
      </artifact>
      <artifact>
        <path>index.html</path>
        <kind>localStorage pattern</kind>
        <symbol>localStorage persistence</symbol>
        <lines>2028-2035, 2117-2125</lines>
        <reason>Story 3-1 pattern: Load saved preset on mount with validation, persist changes with try/catch. Custom presets will follow same error handling pattern.</reason>
      </artifact>
      <artifact>
        <path>index.html</path>
        <kind>React component</kind>
        <symbol>SavePresetDialog</symbol>
        <lines>1598-1746</lines>
        <reason>Story 3-3 implementation: Dialog component for saving/editing presets with name/description/color validation. Already implemented, may need enhancement.</reason>
      </artifact>
      <artifact>
        <path>index.html</path>
        <kind>Helper functions</kind>
        <symbol>addLocalFiles</symbol>
        <lines>2899-2950</lines>
        <reason>Playlist file intake creates track objects with metadata. Track schema will be extended with lastPresetId field for auto-restore.</reason>
      </artifact>
    </code>
    <dependencies>
      <node>
        <package name="fake-indexeddb" version="^6.2.5" scope="devDependencies"/>
      </node>
      <runtime>
        <library name="React" version="18 (UMD)" source="CDN"/>
        <library name="ReactDOM" version="18 (UMD)" source="CDN"/>
        <library name="Babel Standalone" version="latest" source="CDN"/>
      </runtime>
      <browser-apis>
        <api name="localStorage" usage="Preset and order persistence"/>
        <api name="Web Audio API" usage="Parameter application"/>
        <api name="Drag and Drop API" usage="Preset reordering"/>
      </browser-apis>
    </dependencies>
  </artifacts>

  <constraints>
    <development>
      - Follow Story 3-1 localStorage patterns: try/catch error handling, validation on load, graceful fallback to defaults
      - Follow Story 3-2 parameter binding patterns: Use existing state setters, leverage React 18 automatic batching
      - Maintain single-file architecture: All components, helpers, and state in index.html
      - Preserve backward compatibility: Existing tracks without lastPresetId should default to null, not break
      - localStorage quota handling: Show user-friendly error on QuotaExceededError, suggest deleting old presets
      - Deleted preset handling: Always fall back to 'focus' default, never crash or show undefined errors
      - Follow Epic 2 toast pattern: showToast(message, type, duration) for user feedback
    </development>
    <architecture>
      - No backend: All persistence uses localStorage/IndexedDB client-side only
      - PWA-ready: Implementation must work offline with cached assets
      - Accessibility: All modals and controls keyboard navigable, proper ARIA labels
      - React patterns: Functional components with hooks, avoid class components
      - State management: Local component state + lifted state to App component, no Redux/context needed yet
    </architecture>
    <performance>
      - Preset application latency: &lt;100ms from selection to audio parameter update
      - localStorage operations: Wrapped in try/catch to prevent UI blocking
      - Drag/drop reordering: Debounced to avoid excessive localStorage writes
      - Track auto-restore: Should not delay playback start (apply preset asynchronously if needed)
    </performance>
    <testing>
      - Must pass existing regression tests: gain-staging.test.js, file-intake.test.js, url-validation.test.js
      - Unit tests: Test CRUD helpers (save, load, update, delete, getAllPresets) with fake-indexeddb
      - Integration tests: Test dialog → save → list update flow, delete → fallback flow
      - Manual tests: Accessibility (keyboard navigation), edge cases (quota exceeded, name collision)
    </testing>
  </constraints>

  <interfaces>
    <interface>
      <name>applyPreset</name>
      <kind>Function signature</kind>
      <signature>applyPreset(presetObject: Object, presetId: string) : void</signature>
      <path>index.html:2087-2114</path>
      <description>Story 3-1 implementation. Applies audio parameters to Web Audio graph. presetObject contains {speed, intensity, spatialDepth, movement, binaural: {enabled, freq}, noise: {type, volume}}. Custom presets call this with saved parameter object.</description>
    </interface>
    <interface>
      <name>localStorage preset storage</name>
      <kind>Data contract</kind>
      <signature>
        localStorage.setItem('custom-presets', JSON.stringify({
          'custom-preset-123': {
            id: string,
            name: string (max 50 chars),
            description: string (max 200 chars),
            createdAt: number (timestamp),
            lastUsedAt: number (timestamp),
            preset: PresetObject (8 audio parameters),
            color: string (hex color),
            tags: string[]
          }
        }))
      </signature>
      <path>Story specification Task 3-3-1</path>
      <description>localStorage schema for custom preset persistence. Key 'custom-presets' stores object map of preset IDs to preset definitions.</description>
    </interface>
    <interface>
      <name>localStorage preset order</name>
      <kind>Data contract</kind>
      <signature>
        localStorage.setItem('preset-order', JSON.stringify([
          'focus', 'calm', 'energize', // defaults always first
          'custom-preset-1', 'custom-preset-2', // custom in user-defined order
        ]))
      </signature>
      <path>Story specification AC5</path>
      <description>Defines display order for preset list. Defaults always appear first, followed by custom presets in user-defined order.</description>
    </interface>
    <interface>
      <name>Track schema extension</name>
      <kind>Data model</kind>
      <signature>
        track = {
          id: number,
          name: string,
          source: 'local' | 'url',
          file: File | null,
          url: string | null,
          lastPresetId: string | null,       // NEW: Auto-populated when preset changes
          preferredPresetId: string | null,  // NEW: User can pin preset (future)
          metadata: Object
        }
      </signature>
      <path>Story specification AC4</path>
      <description>Extends existing track schema with preset tracking fields. lastPresetId auto-populated during playback, preferredPresetId reserved for future enhancement.</description>
    </interface>
    <interface>
      <name>getAllPresets</name>
      <kind>Helper function to implement</kind>
      <signature>getAllPresets() : Array&lt;PresetObject&gt;</signature>
      <path>Story specification Task 3-3-1</path>
      <description>Merges MODE_LIBRARY defaults with custom presets from localStorage, applies user-defined order from preset-order array, returns combined sorted list for UI rendering.</description>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Tests use Node.js with manual DOM/AudioContext mocking. Pattern: Create mock classes for browser APIs (MockGain, MockNode, etc.), require audio-engine.js module, run assertions with custom assert() helper. Tests stored in tests/ directory, run via npm test script. Story 3-3 should add tests/preset-crud.test.js following same mocking pattern for localStorage and validation logic.
    </standards>
    <locations>
      - tests/preset-crud.test.js (NEW - to be created)
      - tests/gain-staging.test.js (existing - must still pass after changes)
      - tests/file-intake.test.js (existing regression test)
      - tests/url-validation.test.js (existing regression test)
      - tests/session-logging.test.js (existing regression test)
    </locations>
    <ideas>
      <test criterion="AC1">
        - Test saveCustomPreset() creates valid preset in localStorage
        - Test name validation rejects empty names and names &gt;50 chars
        - Test QuotaExceededError handling shows correct error message
      </test>
      <test criterion="AC2">
        - Test getAllPresets() merges defaults + custom in correct order
        - Test preset-order array correctly sorts custom presets
        - Test default presets always appear first regardless of order array
      </test>
      <test criterion="AC3">
        - Test deleteCustomPreset() removes preset and updates tracks
        - Test deleting active preset falls back to 'focus' gracefully
        - Test editing preset preserves createdAt, updates lastUsedAt
      </test>
      <test criterion="AC4">
        - Integration test: Play track → change preset → verify lastPresetId updated
        - Integration test: Replay track → verify preset auto-restores before audio
        - Test fallback to focus when lastPresetId references deleted preset
      </test>
      <test criterion="AC5">
        - Test savePresetOrder() persists to localStorage
        - Test reordering updates preset-order array correctly
        - Test drag/drop logic moves presets in array
      </test>
      <test criterion="AC6">
        - Test export generates valid JSON matching preset schema
        - Test import validates required fields (name, preset)
        - Test import auto-renames on name collision (appends " (2)")
      </test>
    </ideas>
  </tests>
</story-context>
